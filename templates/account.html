{% set is_self = (user.id == session['user_id']) %}
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ user.username }} - Profile</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
<style>
body {
    margin: 0;
    font-family: 'Quicksand', sans-serif;
    background: #f0f4f8;
    display: flex;
    justify-content: center;
}
.container {
    width: 100%;
    max-width: 900px;
    margin: 30px 0;
}

.sidebar {
    width: 220px;
    background-color: #1a4e8a;
    color: white;
    display: flex;
    flex-direction: column;
    padding-top: 20px;
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
}
.sidebar h2 {
    text-align: center;
    margin-bottom: 30px;
    font-weight: 700;
}
.sidebar a {
    color: white;
    text-decoration: none;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    transition: 0.2s;
}
.sidebar a:hover { background: #3a78c2; }
.sidebar a i { margin-right: 10px; }

.profile-header {
    background: #fff;
    padding: 30px 20px;
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    position: relative;
    text-align: center;
}

.avatar-wrapper {
    position: relative;
}
.avatar-wrapper img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #1a4e8a;
}

.profile-info h2 {
    margin: 0;
    font-size: 24px;
    color: #1a4e8a;
}
.profile-slogan {
    font-style: italic;
    font-size: 16px;
    color: #555;
    margin: 5px 0 10px 0;
    text-align: center;
}

.add-slogan-btn {
    font-size: 14px;
    padding: 6px 12px;
    border: none;
    border-radius: 8px;
    background: #1a4e8a;
    color: white;
    cursor: pointer;
    margin: 5px 0 10px 0;
}
.add-slogan-btn:hover { background: #3a78c2; }
.follow-btn {
    padding: 8px 20px;
    background: #1a4e8a;
    color: white;
    border: none;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
    margin-top: 10px;
}
.follow-btn.following {
    background: #eee;
    color: #1a4e8a;
}
.follow-btn:hover { transform: scale(1.05); }

.profile-stats {
    display: flex;
    justify-content: center;
    gap: 20px;
    font-size: 14px;
    color: #555;
    margin-top: 10px;
}

.posts {
    margin-top: 30px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}
.post {
    background: #fff;
    border-radius: 12px;
    padding: 15px 20px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.08);
}
.post img, .post video {
    width: 100%;
    max-height: 400px;
    border-radius: 12px;
    margin-top: 10px;
    object-fit: cover;
}
.post .meta { font-size: 12px; color: #555; margin-bottom: 5px; }
.post .content { margin-top: 5px; font-size: 14px; }
.stats { margin-top: 10px; font-size: 14px; }
.stats i { cursor: pointer; margin-right: 5px; }
.stats i.liked { color: #e74c3c; }
.comments-list { margin-top: 10px; font-size: 13px; }
.comment { display: flex; align-items: flex-start; gap: 5px; margin-top: 5px; }
.comment img { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; }
.comment-content { background: #f0f0f0; padding: 5px 10px; border-radius: 8px; flex: 1; }
.comment-author { font-weight: bold; color: #1a4e8a; }
.comment-time { font-size: 11px; color: #555; margin-left: 5px; }
.comment-stats { margin-left: 10px; }
.comment-form { display: flex; margin-top: 5px; }
.comment-form input { flex: 1; padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
.comment-form button { margin-left: 5px; padding: 5px 10px; border: none; background: #1a4e8a; color: white; border-radius: 5px; cursor: pointer; }
.comment-form button:hover { background: #3a78c2; }

@media screen and (max-width:768px){
    .profile-header { flex-direction: column; align-items: center; text-align: center; }
    .profile-info h2 { margin-top: 10px; }
}
</style>
</head>
<body>
<div class="sidebar">
    <div class="sidebar-top">
        <h2>Nam-blogee</h2>
        <a href="/index"><i class="fas fa-blog"></i> Blog</a>
        <a href="/cartoonize"><i class="fas fa-image"></i> Tạo ảnh</a>
        <a href="{{ url_for('account', user_id=session['user_id']) }}"><i class="fas fa-user"></i> Trang cá nhân</a>
        <a href="/logout"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
</div>
</div>

<div class="container">
    <div class="profile-header">
        <div class="avatar-wrapper">
            <img id="avatarImg" src="{{ url_for('static', filename=user.avatar) if user.avatar else '/static/avatar_default.jpg' }}" alt="avatar">
            {% if is_self %}
            <form id="changeAvatarForm" enctype="multipart/form-data" style="position:absolute; bottom:0; right:0;">
                <label for="avatarInput" style="cursor:pointer; background:#1a4e8a; color:white; padding:3px 8px; border-radius:12px; font-size:12px;">
                    <i class="fas fa-camera"></i>
                </label>
                <input type="file" name="avatar" id="avatarInput" style="display:none">
            </form>
            {% endif %}
        </div>

        <div class="profile-info">
            <h2>{{ user.username }}</h2>

            {% if user.slogan %}
                <p class="profile-slogan">"{{ user.slogan }}"</p>
            {% elif is_self %}
                <div id="sloganWrapper">
                <button class="add-slogan-btn" onclick="showSloganInput()">Thêm slogan</button>
                    </div>
            {% endif %}

            <div class="profile-stats">
                <span id="followersCount"><i class="fas fa-user-friends"></i> Followers: {{ followers_count }}</span>
                <span><i class="fas fa-user-check"></i> Following: {{ following_count }}</span>
            </div>

            {% if not is_self %}
            <button class="follow-btn {% if is_following %}following{% endif %}" id="followBtn" onclick="toggleFollow({{ user.id }})">
                {% if is_following %}Following{% else %}Follow{% endif %}
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Posts -->
    <div class="posts">
        {% for post in posts %}
        <div class="post" data-post-id="{{ post.id }}">
            <div class="meta">{{ post.time.strftime('%d/%m/%Y %H:%M') }}</div>
            <div class="content">{{ post.content }}</div>
            {% if post.image %}<img src="{{ url_for('static', filename=post.image) }}" alt="post image">{% endif %}
            <div class="stats">
                <i class="fas fa-heart {% if post.like %}liked{% endif %}" onclick="toggleLike({{ post.id }}, this)"></i>
                <span class="likes-count">{{ post.like_count }}</span>
                <span class="comments"><i class="fas fa-comment"></i> {{ post.comments|length }}</span>
            </div>
            <div class="comments-list">
                {% for comment in post.comments %}
                <div class="comment" data-comment-id="{{ comment.id }}">
                    <img src="{{ url_for('static', filename=comment.avatar) if comment.avatar else '/static/avatar_default.jpg' }}" alt="avatar">
                    <div class="comment-content">
                        <span class="comment-author">{{ comment.customer_name }}</span>
                        <span class="comment-time">{{ comment.time.strftime('%d/%m/%Y %H:%M') }}</span>
                        <p>{{ comment.content }}</p>
                        <div class="comment-stats">
                            <i class="fas fa-thumbs-up {% if comment.liked %}liked{% endif %}" onclick="toggleCommentLike({{ comment.id }}, this)"></i>
                            <span class="comment-likes-count">{{ comment.like_count }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <form class="comment-form" onsubmit="addComment(event, {{ post.id }})">
                <input type="text" name="content" placeholder="Viết bình luận..." required>
                <button type="submit">Bình luận</button>
            </form>
        </div>
        {% endfor %}
    </div>
</div>
<script>
// Follow/Unfollow
async function toggleFollow(userId){
    const btn = document.getElementById('followBtn');
    try{
        const res = await fetch(`/follow/${userId}`, { method: "POST" });
        const data = await res.json();
        if(res.ok){
            document.getElementById('followersCount').innerHTML = `<i class="fas fa-user-friends"></i> Followers: ${data.followers_count}`;
            if(data.following_now){
                btn.textContent = 'Following';
                btn.classList.add('following');
            } else {
                btn.textContent = 'Follow';
                btn.classList.remove('following');
            }
        }
    } catch(e){ alert('Lỗi mạng: '+e.message); }
}

// Like post
async function toggleLike(postId, el){
    try{
        const res = await fetch(`/like_post`, { 
            method: "POST", 
            body: new URLSearchParams({post_id: postId})
        });
        const data = await res.json();
        if(res.ok){
            el.classList.toggle('liked', data.liked);
            const likesCount = el.parentElement.querySelector('.likes-count');
            if(likesCount) likesCount.textContent = data.like_count;
        }
    } catch(e){ alert('Lỗi: '+e.message); }
}

// Like comment
async function toggleCommentLike(commentId, el){
    try{
        const res = await fetch(`/like_comment`, {
            method: "POST",
            body: new URLSearchParams({comment_id: commentId})
        });
        const data = await res.json();
        if(res.ok){
            el.classList.toggle('liked', data.liked);
            const likesCount = el.parentElement.querySelector('.comment-likes-count');
            if(likesCount) likesCount.textContent = data.like_count;
        }
    } catch(e){ alert('Lỗi: '+e.message); }
}

// Add comment
async function addComment(e, postId){
    e.preventDefault();
    const form = e.target;
    const input = form.querySelector('input[name="content"]');
    const content = input.value.trim();
    if(!content) return;
    try{
        const res = await fetch(`/add_comment/${postId}`, {
            method: "POST",
            body: new URLSearchParams({content})
        });
        const data = await res.json();
        if(res.ok){
            const postDiv = form.closest('.post');
            const commentsList = postDiv.querySelector('.comments-list');
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment';
            commentDiv.dataset.commentId = data.id;
            commentDiv.innerHTML = `
                <img src="${data.avatar_url || '/static/avatar_default.jpg'}">
                <div class="comment-content">
                    <span class="comment-author">${data.user}</span>
                    <span class="comment-time">Vừa xong</span>
                    <p>${data.content}</p>
                    <div class="comment-stats">
                        <i class="fas fa-thumbs-up" onclick="toggleCommentLike(${data.id}, this)"></i>
                        <span class="comment-likes-count">0</span>
                    </div>
                </div>
            `;
            commentsList.appendChild(commentDiv);

            const commentsCount = postDiv.querySelector('.stats .comments');
            if(commentsCount){
                commentsCount.innerHTML = `<i class="fas fa-comment"></i> ${commentsList.children.length}`;
            }
            input.value = '';
        }
    } catch(e){ alert('Lỗi: '+e.message); }
}

document.getElementById('avatarInput').addEventListener('change', async function(){
    const file = this.files[0];
    if(!file) return;

    const formData = new FormData();
    formData.append('avatar', file);

    try{
        const res = await fetch('/change_avatar', {
            method: 'POST',
            body: formData
        });
        if(res.ok){
            // Cập nhật avatar trên trang mà không reload
            const avatarImg = document.querySelector('.profile-header img');
            const ext = file.name.split('.').pop();
            avatarImg.src = `/static/avatar/{{ session['user_id'] }}.${ext}?t=${new Date().getTime()}`;
        } else {
            alert('Upload thất bại');
        }
    } catch(e){
        alert('Lỗi mạng: ' + e.message);
    }
});
function showSloganInput() {
    const wrapper = document.getElementById('sloganWrapper');
    wrapper.innerHTML = `
        <input type="text" id="sloganInput" placeholder="Nhập slogan..." style="padding:5px 10px; border-radius:5px; border:1px solid #ccc;">
        <button class="add-slogan-btn" onclick="saveSlogan()">Lưu</button>
        <button class="add-slogan-btn" onclick="cancelSlogan()" style="background:#ccc;color:#333;">Hủy</button>
    `;
}

function cancelSlogan() {
    const wrapper = document.getElementById('sloganWrapper');
    wrapper.innerHTML = `<button class="add-slogan-btn" onclick="showSloganInput()">Thêm slogan</button>`;
}
async function saveSlogan() {
    const input = document.getElementById('sloganInput');
    const slogan = input.value.trim();
    if(!slogan) return alert('Slogan không được để trống!');
    try {
        const res = await fetch('/save_slogan', {
            method: 'POST',
            body: new URLSearchParams({slogan})
        });
        const data = await res.json();
        if(res.ok){
            const wrapper = document.getElementById('sloganWrapper');
            wrapper.innerHTML = `<p class="profile-slogan" id="profileSlogan">"${data.slogan}"</p>`;
        } else {
            alert(data.error || 'Lỗi lưu slogan');
        }
    } catch(e){ alert('Lỗi mạng: '+e.message); }
}
</script>

</body>
</html>
